<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="titleid">AI</title>
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
  <link href="{{ url_for('static', filename='css/bootstrap-icons.css') }}" rel="stylesheet">
  <link rel="icon" href="{{ url_for('static', filename='imgs/favicon.ico') }}">

  <style>
    /* Same robot-control-panel CSS as before */
    .robot-control-panel {
      margin-top: 20px;
      width: 180px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .control-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      width: 100%;
    }
    .direction-btn {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      background-color: #343a40;
      border: none;
      color: white;
      font-size: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
    }
    .direction-btn:hover {
      background-color: #495057;
      transform: scale(1.05);
    }
    .direction-btn:active {
      background-color: #212529;
      transform: scale(0.95);
    }
    .btn-up { grid-column: 2; grid-row: 1; }
    .btn-left { grid-column: 1; grid-row: 2; }
    .btn-right { grid-column: 3; grid-row: 2; }
    .btn-down { grid-column: 2; grid-row: 3; }

    .custom-tab {
    font-weight: bold;
    color: #adb5bd; /* light gray for inactive */
    background-color: #343a40; /* darker background for tabs */
    border: none;
    border-radius: 0;
    margin-right: 5px;
    padding: 10px 15px;
    transition: all 0.3s ease;
  }
  .custom-tab.active {
    color: white;
    background-color: #495057; /* slightly lighter bg for active tab */
    border-bottom: 3px solid #0d6efd; /* Bootstrap blue */
  }
  .nav-tabs {
    border-bottom: none;
  }
  
  /* Config Container Styles */
  .tab-content {
    height: calc(100vh - 40px);
    overflow: hidden;
    background-color: #0d1117;
  }
  
  #config {
    height: 100%;
    background-color: #0d1117;
    display: flex;
    flex-direction: column;
  }
  
  .config-container {
    height: 100%;
    display: flex;
    flex-direction: column;
    background-color: #0d1117;
  }
  
  .config-header {
    background: linear-gradient(135deg, #1a1d20 0%, #0d1117 100%);
    padding: 16px 20px;
    border-bottom: 2px solid rgba(13, 110, 253, 0.3);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    flex-shrink: 0;
  }
  
  .config-header h4 {
    color: #f8f9fa;
    font-weight: 600;
    font-size: 18px;
  }
  
  .save-config-btn {
    padding: 8px 16px;
    font-weight: 600;
    font-size: 12px;
    border-radius: 6px;
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    border: none;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    min-width: fit-content;
    flex-shrink: 0;
  }
  
  .save-config-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.4);
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
  }
  
  .save-config-btn:active {
    transform: translateY(0);
  }
  
  .save-config-btn-success {
    padding: 8px 16px;
    font-weight: 600;
    font-size: 12px;
    border-radius: 6px;
    background: linear-gradient(135deg, #198754 0%, #0f5132 100%) !important;
    border: none !important;
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4) !important;
    transition: all 0.3s ease;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    min-width: fit-content;
    flex-shrink: 0;
  }

  /* Spinning animation for saving state */
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .spin {
    animation: spin 1s linear infinite;
  }
  
  .config-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px 25px;
    background-color: #0d1117;
  }
  
  #configAccordion {
    margin-bottom: 0 !important;
  }
  
  /* Config Accordion Styles */
  .config-accordion-item {
    background: linear-gradient(145deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
    border: 1px solid rgba(13, 110, 253, 0.2) !important;
    border-radius: 8px !important;
    overflow: hidden;
    margin-bottom: 8px;
  }
  
  .config-accordion-item:last-child {
    margin-bottom: 0 !important;
  }
  
  .config-accordion-item:hover {
    border-color: rgba(13, 110, 253, 0.4) !important;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
  }
  
  .config-accordion-button {
    background: rgba(13, 110, 253, 0.1) !important;
    color: #0d6efd !important;
    font-size: 14px;
    padding: 12px 16px;
    border: none !important;
  }
  
  .config-accordion-button:not(.collapsed) {
    background: rgba(13, 110, 253, 0.2) !important;
    color: #0d6efd !important;
    box-shadow: none !important;
  }
  
  .config-accordion-button:focus {
    box-shadow: none !important;
    border: none !important;
  }
  
  .config-accordion-button::after {
    filter: brightness(0) invert(1);
  }
  
  .config-accordion-body {
    background: transparent;
    padding: 16px;
  }
  
  .field-wrapper {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 10px;
    transition: background-color 0.2s ease;
  }
  
  .field-wrapper:hover {
    background-color: rgba(0, 0, 0, 0.5);
  }
  
  .config-accordion-body .form-label {
    color: #adb5bd;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
  }
  
  /* Servo Group Styles */
  .servo-group {
    background: rgba(13, 110, 253, 0.05);
    border-radius: 8px;
    padding: 15px;
    border: 1px solid rgba(13, 110, 253, 0.15);
  }
  
  .servo-group-title {
    color: #0d6efd;
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(13, 110, 253, 0.2);
    display: flex;
    align-items: center;
  }
  
  .config-input {
    background-color: #1a1d20 !important;
    border: 1px solid #343a40 !important;
    color: #f8f9fa !important;
    transition: all 0.2s ease;
  }
  
  .config-input:focus {
    background-color: #212529 !important;
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
  }
  
  .config-section .form-check-input {
    background-color: #343a40;
    border-color: #495057;
    width: 3rem;
    height: 1.5rem;
    cursor: pointer;
  }
  
  .config-section .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
  }
  
  .config-hint {
    display: flex;
    align-items: start;
    gap: 4px;
    color: #6c757d;
    font-size: 0.75rem;
    line-height: 1.3;
    padding: 6px 8px;
    background-color: rgba(108, 117, 125, 0.1);
    border-radius: 4px;
    border-left: 2px solid rgba(13, 110, 253, 0.4);
  }
  
  .config-hint i {
    color: #0d6efd;
    margin-top: 2px;
    flex-shrink: 0;
  }
  </style>
</head>

<body>

  <audio id="audioPlayer" controls hidden></audio>

<!-- TABS HEADER -->
<ul class="nav nav-tabs" id="myTab" role="tablist" style="background-color: #212529; border-bottom: none;">
    <li class="nav-item" role="presentation">
      <button style="width:fit-content;" class="nav-link active d-flex align-items-center gap-2 custom-tab" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
        <i class="bi bi-chat-dots-fill"></i> Chat UI
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button style="width:fit-content;" class="nav-link d-flex align-items-center gap-2 custom-tab" id="motion-tab" data-bs-toggle="tab" data-bs-target="#motion" type="button" role="tab">
        <i class="bi bi-joystick"></i> Motion Control
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button style="width:fit-content;" class="nav-link d-flex align-items-center gap-2 custom-tab" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
        <i class="bi bi-gear-fill"></i> Configuration
      </button>
    </li>
  </ul>

  <!-- TABS CONTENT -->
  <div class="tab-content" id="myTabContent">
    
    <!-- CHAT UI TAB -->
    <div class="tab-pane fade show active p-3" id="chat" role="tabpanel">
      <div class="chat-container">
        <div class="card h-100 gradient-custom">
          <div class="card-body" data-mdb-perfect-scrollbar="true">
            <div class="chat-messages" style="padding: 0%; margin: 0%;">
              <div class="d-flex justify-content-left" style="padding: 0px; margin: 0px;">
                <p class="small mb-1 name" id="bot name" style="padding: 0px; margin: 0px;">$CHARNAME</p>
                <p class="small mb-1 text-muted" id="timestamp first" style="padding: 0px; margin: 0px;"></p>
              </div>
              <div class="d-flex flex-row justify-content-left mb-4 pt-1" style="display: inline-block;">
                <img src="{{ url_for('static', filename='imgs/user.png') }}" id="bot png" alt="avatar 1" style="width: 45px; height: 100%;">
                <div class="d-flex flex-row" style="box-shadow: 0 2px 4px rgb(0, 0, 0, 0.404); border: 0px solid rgb(129, 129, 129); margin-bottom: 0px; background-color: rgba(0, 0, 0, 0.404); border-radius: 10px; padding: 1%;">
                  <p class="firstmess" id="bot firstmess" style="margin: 0px; padding: 0px; color: rgb(204, 204, 204);">$REPLACEFIRSTMEMESSAGE</p>
                </div>
              </div>
              <div id="output"></div>
            </div>
          </div>
        </div>
      </div>

      <img style="top:25%; height:50%;" id="backgroundImage" src="" alt="Background Image">

      <form id="imageUploadForm" method="POST" enctype="multipart/form-data" action="/upload" hidden>
        <input class="form-control" type="file" id="imageUpload" name="file" accept="image/*">
      </form>

      <div id="imagePreviewContainer">
        <img id="imagePreview" src="" alt="Preview">
        <button id="removeImageButton">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <div class="input-group">
        <input type="text" id="prompt" class="form-control border-end-0" placeholder="Type message" />
        <button id="muteButton" class="btn btn-secondary" type="button">
          <i class="bi bi-volume-up-fill"></i>
        </button>
        <button id="uploadImageButton" class="btn btn-primary" type="button">
          <i class="bi bi-upload"></i>
        </button>
        <button class="btn btn-primary" type="button" id="button-addon2">
          <i class="bi bi-arrow-right-circle-fill"></i>
        </button>
      </div>
    </div>

    <!-- MOTION CONTROL TAB -->
    <div class="tab-pane fade p-3" id="motion" role="tabpanel">
      <div class="robot-control-panel" id="robotControlPanel">
        <div class="control-buttons">
          <button class="direction-btn btn-up" id="btnUp" aria-label="Move Forward">
            <i class="bi bi-arrow-up"></i>
          </button>
          <button class="direction-btn btn-left" id="btnLeft" aria-label="Move Left">
            <i class="bi bi-arrow-left"></i>
          </button>
          <button class="direction-btn btn-right" id="btnRight" aria-label="Move Right">
            <i class="bi bi-arrow-right"></i>
          </button>
          <button class="direction-btn btn-down" id="btnDown" aria-label="Move Backward">
            <i class="bi bi-arrow-down"></i>
          </button>
        </div>
        <!-- Action Selection Dropdown -->
        <div class="mt-3" style="text-align: center;">
          <select id="actionSelect" class="form-select mb-2" style="width: 100%;">
            <option value="0">Reset Position</option>
            <!-- <option value="1">Move Forward</option>
            <option value="2">Move Backward</option>
            <option value="3">Turn Right</option>
            <option value="4">Turn Left</option> -->
            <option value="5">Greet</option>
            <option value="6">Simulate Laughter</option>
            <option value="7">Dynamic Motion</option>
            <option value="8">PEZZ Dispenser</option>
            <option value="9">Now!</option>
            <option value="10">Balance</option>
            <option value="11">Mic Drop</option>
            <option value="12">Defensive Posture</option>
            <option value="13">Pose</option>
            <option value="14">Bow</option>
          </select>
          <button class="btn btn-primary" onclick="executeAction()" style="width: 100%;">Execute Action</button>
        </div>

      </div>
    </div>

    <!-- CONFIG TAB -->
    <div class="tab-pane fade p-0" id="config" role="tabpanel" style="position: relative;">
      <div class="config-container">
        <div class="config-header">
          <div class="d-flex justify-content-between align-items-center w-100">
            <div class="d-flex align-items-center">
              <i class="bi bi-gear-fill me-2" style="color: #0d6efd; font-size: 24px;"></i>
              <h4 class="mb-0">Configuration Settings</h4>
            </div>
            <div class="ms-auto">
              <button class="btn btn-primary save-config-btn" id="saveConfigBtn">
                <i class="bi bi-save"></i>
                <span>Save Changes</span>
              </button>
            </div>
          </div>
        </div>
        <div class="config-body">
          <div id="configForm">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3 text-muted">Loading configuration...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>



<script>
// Declare a global variable to store the base URL
let talkingheadBaseUrl = '';

const tabButtons = document.querySelectorAll('.custom-tab');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

// Fetch the talking head base URL from the backend
fetch('/get_ip')
    .then(response => response.json())
    .then(data => {
        // Store the base URL in the global variable
        talkingheadBaseUrl = data.talkinghead_base_url;

        // Update the image source or do other initial actions
        const fullUrl = talkingheadBaseUrl + "/stream";
        document.getElementById('backgroundImage').src = fullUrl;
    })
    .catch(error => console.error('Error fetching talking head URL:', error));

const talkinghead_url = "{{ talkinghead_base_url }}";
const parser = new DOMParser();
let decodedUrl = parser.parseFromString(`<!doctype html><body>{{ talkinghead_base_url }}`, 'text/html').body.textContent;
decodedUrl = decodedUrl.replace(/^"|"$/g, '');
console.log(decodedUrl);
let isMuted = false;

function start_talking() {
if (!isMuted) {
fetch(talkingheadBaseUrl + "/start_talking")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
            })
            .catch(error => console.error('Fetch error:', error));
}
}

function stop_talking() {
fetch(talkingheadBaseUrl + "/stop_talking")
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => console.error('Fetch error:', error));
}

document.addEventListener("DOMContentLoaded", function () {
const audioPlayer = document.getElementById("audioPlayer");
const muteButton = document.getElementById("muteButton");

// Initialize the audio as unmuted

muteButton.addEventListener("click", function () {
const icon = this.querySelector('i'); // Find the icon within the button
if (isMuted) {
// If audio is currently muted, unmute it and switch icon to volume-up
audioPlayer.muted = false;
icon.classList.remove('bi-volume-mute-fill');
icon.classList.add('bi-volume-up-fill');
muteButton.setAttribute('aria-label', 'Mute'); // Update aria-label for accessibility
                  // Check if the audio is playing
if (!audioPlayer.paused) {
// Send fetch request to start talking



//const startTalkingUrl = talkingheadBaseUrl + "/start_talking";
start_talking();
}
} else {
// If audio is currently unmuted, mute it and switch icon to volume-mute
audioPlayer.muted = true;
icon.classList.remove('bi-volume-up-fill');
icon.classList.add('bi-volume-mute-fill');
muteButton.setAttribute('aria-label', 'Unmute'); // Update aria-label for accessibility

                  // Send fetch request to stop talking
stop_talking();
}

// Toggle the mute state
isMuted = !isMuted;
});
});

var audioPlayer = document.getElementById('audioPlayer');

// Function to handle the 'ended' event
function handleAudioEnd() {
// Call the /talking_stop endpoint right after the audio stops if not muted
if (!audioPlayer.muted) {
  fetch(talkingheadBaseUrl + "/stop_talking")
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          // Handle the response if necessary
      })
      .catch(error => console.error('Fetch error:', error));
}
}

// Add event listener for 'ended' event
audioPlayer.addEventListener('ended', handleAudioEnd);

let audioStarted = false; // Prevent multiple requests
let firstChunkPlayed = false; // Track if first chunk already played

function startAudioStream() {
if (audioStarted) {
// console.log("Audio stream already started, ignoring duplicate request.");
return; // ðŸš¨ Prevent duplicate requests
}
audioStarted = true; // âœ… Mark that audio has started
firstChunkPlayed = false; // âœ… Reset for new message

fetch('/audio_stream')
.then(response => response.blob())
.then(blob => {
    if (blob.size === 0) {
        // console.error("Received an empty first chunk!");
        return;
    }

    const audioUrl = URL.createObjectURL(blob);
    audioPlayer.src = audioUrl;
    audioPlayer.load();

    audioPlayer.play().then(() => {
        // console.log("Playing first MP3 chunk...");
        firstChunkPlayed = true; // âœ… Mark first chunk as played

        // âœ… Wait for first chunk to finish before fetching next
        audioPlayer.onended = function () {
            // console.log("First chunk finished, requesting next...");
            setTimeout(() => {
                playNextAudioChunk();
            }, 500);
        };
    }).catch(error => {
        console.error("Error playing first MP3 chunk:", error);
    });
})
.catch(error => console.error("Error starting MP3 audio stream:", error));
}

function playNextAudioChunk() {
fetch('/get_next_audio_chunk')
.then(response => {
if (response.status === 204) {
    // console.log("No more audio chunks.");
    stop_talking()
    audioStarted = false; // âœ… Reset audio system after last chunk
    return null; // No more content
}
return response.blob();
})
.then(blob => {
if (blob) {
    const audioUrl = URL.createObjectURL(blob);
    audioPlayer.src = audioUrl;
    audioPlayer.load();

    audioPlayer.play().then(() => {
        // console.log("Playing next MP3 chunk...");
            start_talking()
        // âœ… Ensure we reset audioStarted only after the last chunk
        audioPlayer.onended = function () {
            // console.log("Chunk finished, requesting next...");
            setTimeout(() => playNextAudioChunk(), 500);
        };
    });
}
})
.catch(error => console.error("Error fetching next MP3 chunk:", error));
}

function executeAction() {
  const selectedAction = document.getElementById('actionSelect').value;

  fetch('/execute_action', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ action: selectedAction }),
  })
  .then(response => response.json())
  .then(data => {
    console.log('Action execution response:', data);
  })
  .catch(error => {
    console.error('Error executing action:', error);
  });
}


document.addEventListener('DOMContentLoaded', function() {   
    // Robot Direction Controls
    const btnUp = document.getElementById('btnUp');
    const btnDown = document.getElementById('btnDown');
    const btnLeft = document.getElementById('btnLeft');
    const btnRight = document.getElementById('btnRight');
    
    btnUp.addEventListener('click', function() {
        moveRobot('forward');
    });
    
    btnDown.addEventListener('click', function() {
        moveRobot('backward');
    });
    
    btnLeft.addEventListener('click', function() {
        moveRobot('left');
    });
    
    btnRight.addEventListener('click', function() {
        moveRobot('right');
    });


    function moveRobot(direction) {
        // Send the movement command to the server
        fetch('/robot_move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ direction: direction }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Robot movement response:', data);
        })
        .catch(error => {
            console.error('Error moving robot:', error);
        });
    }


    let selectedImageFile = null; // Store the image file

document.getElementById('uploadImageButton').addEventListener('click', function () {
    document.getElementById('imageUpload').click();
});

document.getElementById('imageUpload').addEventListener('change', function () {
    const imageFile = this.files[0];

    if (imageFile) {
        console.log("Image selected:", imageFile.name); // âœ… Check if image is detected
        selectedImageFile = imageFile; // Store the image file
        
        // Show the preview
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreviewContainer').style.display = 'block';
        };
        reader.readAsDataURL(imageFile);
    }
});


// Remove Image Button
document.getElementById('removeImageButton').addEventListener('click', function () {
    selectedImageFile = null; // Clear stored image
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    if (imagePreviewContainer) {
        imagePreviewContainer.style.display = 'none';
        document.getElementById("imagePreview").src = ""; // Clear preview source
    }
});


var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('bot_message', function(data) {
        //console.log('Received botmessage:', data.message);
        displayBotMessage(data.message);
    });

    socket.on('user_message', function(data) {
        //console.log('Received botmessage:', data.message);
        displayUserMessage(data.message);
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server. Attempting to reconnect...');
        setTimeout(function() {
            socket.connect();
        }, 5000); // Attempt to reconnect after 5 seconds
    });

    socket.on('heartbeat', function(msg) {
        //console.log('Heartbeat received from server');
        socket.emit('heartbeat', {status: 'alive'});
    });



    function formatText(text) {
    // Convert newline characters to HTML line breaks
    text = text.replace(/\n/g, '<br>');

    // Replace text enclosed within * with emphasized text
    text = text.replace(/\*(.*?)\*/g, '<span class="emphasized-text">$1</span>'); 

    // Replace text enclosed within `` with code text styling
    text = text.replace(/``(.*?)``/g, '<span class="code-text">$1</span>');

    // Corrected Unicode character replacement
    text = text.replace(/\\u([\dA-F]{4})/gi, function(match, group1) {
        return String.fromCharCode(parseInt(group1, 16));
    });
    
    return text;
}


  try {
      // Assign values to myChar properties
      myChar = {
        charName: "{{ char_name }}",
        char_greeting: "{{ char_greeting }}"
      };

      // Set values in the HTML elements
      const botFirstMess = document.getElementById('bot firstmess');

      botFirstMess.innerHTML = formatText(myChar.char_greeting);
  
      const botName = document.getElementById('bot name');
      botName.innerHTML = myChar.charName;

      const titleid = document.getElementById('titleid');
      titleid.innerHTML = myChar.charName;

      const botPng = document.getElementById('bot png');
      botPng.src = `{{ url_for('static', filename='imgs/char.png') }}`;
  
    } catch (error) {
      console.error(error);
    }

    const promptInput = document.getElementById('prompt');
    const sendButton = document.getElementById('button-addon2');


    function sendMessage() {
    const userInput = promptInput.value.trim();
    if (userInput || selectedImageFile) {
        displayUserMessage(userInput);
        sendUserMessage(userInput, selectedImageFile);

        promptInput.value = '';

        // âœ… Remove the image after sending
        selectedImageFile = null; 
        const imagePreviewContainer = document.getElementById("imagePreviewContainer");
        if (imagePreviewContainer) {
            imagePreviewContainer.style.display = "none";
            document.getElementById("imagePreview").src = "";
        }

        delayedMessage();
    }
}

sendButton.addEventListener("click", sendMessage);

promptInput.addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
});



    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Usage within an async function
    async function delayedMessage() {
        await delay(1000); // Wait for 2 seconds
        displayBotMessage("", true);
    }

function sendUserMessage(message, imageFile) {
    const formData = new FormData();
    formData.append("message", message);

    if (imageFile) {
        formData.append("file", imageFile);
        console.log("File added to FormData:", imageFile.name); // âœ… Debugging
    } else {
        console.log("No image selected");
    }

    fetch("/process_llm", {
        method: "POST",
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        console.log("Server response:", data);
    })
    .catch(error => {
        console.error("Error:", error);
    });
}




    function displayBotMessage(message, isTemporary = false) {
    const chatBody = document.getElementsByClassName("card-body")[0];

    // Create elements for the bot message container
    const responseContainer = document.createElement("div");
    responseContainer.className = "d-flex flex-row justify-content-left mb-4 pt-1";

    // Create the bot avatar image element
    const avatarElement = document.createElement("img");
    avatarElement.src = "/static/imgs/char.png"; // URL for the bot's avatar image
    avatarElement.alt = "avatar 1";
    avatarElement.style.width = "45px";
    avatarElement.style.height = "100%";
    responseContainer.appendChild(avatarElement);

    // Create the message content container
    const responseContent = document.createElement("div");
    responseContent.className = "response-content";
    responseContent.style.border = "0px solid rgb(129, 129, 129)";
    responseContent.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.404)";
    responseContent.style.backgroundColor = "rgba(0, 0, 0, 0.404)";
    responseContent.style.borderRadius = "10px";
    responseContent.style.padding = "1%";
    responseContent.style.marginLeft = "10px"; // Add some space between the avatar and the message

    // Parse the message for *emphasis* and apply styling
    // const formattedMessage = message.replace(/\*(.*?)\*/g, '<font style="color: grey;">$1</font>');
    const formattedMessage = formatText(message);
    
    // Create a div element to hold the formatted message
    const responseText = document.createElement("div");
    responseText.className = "response-text";
    responseText.innerHTML = formattedMessage;

    // Append the formatted message to the content container
    responseContent.appendChild(responseText);

    // Append the content container to the message container
    responseContainer.appendChild(responseContent);

    if (isTemporary) {
        responseContainer.classList.add("is-typing");
        // New code: Apply the typing-dots class to the specific element that will contain "Is Typing..."
        const typingElement = document.createElement("div");
        typingElement.textContent = "Is Typing";
        typingElement.className = "typing-dots"; // Apply the animation class
        responseContent.appendChild(typingElement);
    } else {
        
        // Remove any existing "Is typing..." messages when displaying a new actual message
        removeTypingMessage();
    }
    // Append the complete message container to the chat body
    chatBody.appendChild(responseContainer);

    // Scroll to the bottom of the chat body to show the new message
    chatBody.scrollTop = chatBody.scrollHeight;


    startAudioStream();
}

    function removeTypingMessage() {
        const chatBody = document.getElementsByClassName("card-body")[0];
        const typingMessages = chatBody.getElementsByClassName("is-typing");
        while (typingMessages.length > 0) {
            typingMessages[0].parentNode.removeChild(typingMessages[0]);
        }
    }






    function displayUserMessage(message) {
    const chatBody = document.getElementsByClassName("card-body")[0];

    // Create the user message container
    var userInputContainer = document.createElement("div");
    userInputContainer.className = "d-flex flex-row justify-content-end mb-4 pt-1";
    userInputContainer.style.display = "inline-block";
    userInputContainer.style.width = "100%"; // Ensure full width

    // Create a separate div for the image (right-aligned)
    const imgContainer = document.createElement("div");
    imgContainer.style.display = "flex";
    imgContainer.style.justifyContent = "flex-end"; // Image aligned to the right
    imgContainer.style.width = "100%"; // Full width container
    imgContainer.style.marginBottom = "5px"; // Space between image and text

    // If an image is selected, add it to imgContainer
    if (selectedImageFile) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const imgElement = document.createElement("img");
            imgElement.src = e.target.result;
            imgElement.style.maxWidth = "200px";
            imgElement.style.borderRadius = "10px";
            imgElement.style.display = "block";
            imgElement.style.marginLeft = "auto"; // Forces image to right side
            imgContainer.appendChild(imgElement);
        };
        reader.readAsDataURL(selectedImageFile);
    }

    // Create a div for the text (left-aligned)
    var userInputContent = document.createElement("div");
    userInputContent.className = "d-flex flex-column";
    userInputContent.style.color = "rgb(204, 204, 204)";
    userInputContent.style.border = "0px solid rgb(129, 129, 129)";
    userInputContent.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.404)";
    userInputContent.style.backgroundColor = "rgba(0, 0, 0, 0.404)";
    userInputContent.style.borderRadius = "10px";
    userInputContent.style.padding = "1%";
    userInputContent.style.marginRight = "10px";
    userInputContent.style.maxWidth = "80%"; // Increased to allow longer lines before wrapping
    userInputContent.style.alignSelf = "flex-start"; // Ensures text stays left-aligned

    // Create user input text
    var userInputText = document.createElement("p");
    userInputText.className = "firstmess";
    userInputText.id = "user";
    userInputText.innerHTML = formatText(message);
    userInputText.style.color = "rgb(204, 204, 204)";
    userInputText.style.margin = "0";
    userInputText.style.padding = "0";

    // âœ… Apply fixes for line breaking:
    userInputText.style.whiteSpace = "nowrap"; // Prevents breaking until necessary
    userInputText.style.wordBreak = "normal"; // Ensures words only break when necessary
    userInputText.style.overflowWrap = "break-word"; // Allows breaking at natural word boundaries

    // Append text inside the message bubble (aligned LEFT)
    userInputContent.appendChild(userInputText);

    // Append the elements in order: IMAGE (right-aligned) â†’ TEXT (left-aligned)
    userInputContainer.appendChild(imgContainer); // Image comes first
    userInputContainer.appendChild(userInputContent); // Text below the image

    var userAvatar = document.createElement("img");
    userAvatar.src = "/static/imgs/user.png";
    userAvatar.alt = "avatar 1";
    userAvatar.style.width = "45px";
    userAvatar.style.height = "100%";

    userInputContainer.appendChild(userAvatar);
    chatBody.appendChild(userInputContainer);

    chatBody.scrollTop = chatBody.scrollHeight;
}

// Configuration Management Functions
function loadConfiguration() {
    fetch('/get_config')
        .then(response => response.json())
        .then(data => {
            const configForm = document.getElementById('configForm');
            let formHtml = '<div class="accordion" id="configAccordion">';
            let sectionIndex = 0;
            
            for (const [section, fields] of Object.entries(data.config)) {
                // Get section description
                const sectionDesc = data.field_options[`${section}.__section__`];
                const accordionId = `collapse${sectionIndex}`;
                const isFirstSection = sectionIndex === 0;
                
                formHtml += `
                    <div class="accordion-item config-accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button config-accordion-button ${isFirstSection ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#${accordionId}" 
                                    aria-expanded="${isFirstSection ? 'true' : 'false'}" aria-controls="${accordionId}">
                                <i class="bi bi-folder-fill me-2"></i>
                                <span class="fw-bold">${section}</span>
                                ${sectionDesc ? `<small class="ms-2 text-muted opacity-75">- ${sectionDesc.description || sectionDesc}</small>` : ''}
                            </button>
                        </h2>
                        <div id="${accordionId}" class="accordion-collapse collapse ${isFirstSection ? 'show' : ''}" data-bs-parent="#configAccordion">
                            <div class="accordion-body config-accordion-body">
                `;
                
                // Special handling for SERVO section - organize into groups
                if (section === 'SERVO') {
                    console.log('SERVO fields:', fields);
                    const generalFields = ['voicemovement', 'MOVEMENT_VERSION'];
                    const v1Fields = ['portMain', 'portForarm', 'portHand', 'starMain', 'starForarm', 'starHand'];
                    const v2RightFields = ['portMainMin', 'portMainMax', 'portForarmMin', 'portForarmMax', 'portHandMin', 'portHandMax'];
                    const v2LeftFields = ['starMainMin', 'starMainMax', 'starForarmMin', 'starForarmMax', 'starHandMin', 'starHandMax'];
                    const torsoFields = ['upHeight', 'neutralHeight', 'downHeight'];
                    const leftLegFields = ['forwardStarboard', 'neutralStarboard', 'backStarboard', 'perfectStaroffset'];
                    const rightLegFields = ['forwardPort', 'neutralPort', 'backPort', 'perfectPortoffset'];
                    
                    // General Settings
                    formHtml += `
                        <div class="servo-group mb-3">
                            <h6 class="servo-group-title"><i class="bi bi-sliders me-2"></i>General Settings</h6>
                            <div class="row g-3">
                    `;
                    generalFields.forEach(key => {
                        if (fields[key] !== undefined) {
                            const fieldId = `config_${section}_${key}`;
                            const fieldInfo = data.field_options[`${section}.${key}`];
                            const description = fieldInfo?.description || '';
                            const value = fields[key];
                            
                            formHtml += `<div class="col-md-6">
                                <div class="field-wrapper">
                                    <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                        <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                        <span>${key}</span>
                                    </label>`;
                            
                            if (fieldInfo && fieldInfo.options) {
                                formHtml += `<select class="form-select form-select-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}">`;
                                fieldInfo.options.forEach(option => {
                                    const selected = String(value) === String(option) ? 'selected' : '';
                                    formHtml += `<option value="${option}" ${selected}>${option}</option>`;
                                });
                                formHtml += '</select>';
                            } else if (typeof value === 'boolean' || value === 'True' || value === 'False') {
                                const checked = (value === true || value === 'True') ? 'checked' : '';
                                formHtml += `
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input config-toggle" type="checkbox" id="${fieldId}" data-section="${section}" data-key="${key}" ${checked}>
                                        <label class="form-check-label small text-white" for="${fieldId}" id="${fieldId}_label">
                                            ${checked ? 'Enabled' : 'Disabled'}
                                        </label>
                                    </div>
                                `;
                            } else {
                                formHtml += `<input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                            }
                            
                            if (description) {
                                formHtml += `
                                    <div class="config-hint mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <small>${description}</small>
                                    </div>
                                `;
                            }
                            formHtml += '</div></div>';
                        }
                    });
                    formHtml += '</div></div>';
                    
                    // V1 ARMS Variables
                    formHtml += `
                        <div class="servo-group mb-3">
                            <h6 class="servo-group-title"><i class="bi bi-joystick me-2"></i>V1 ARMS Variables (Legacy)</h6>
                            <div class="row g-3">
                    `;
                    v1Fields.forEach(key => {
                        if (fields[key] !== undefined) {
                            const fieldId = `config_${section}_${key}`;
                            const fieldInfo = data.field_options[`${section}.${key}`];
                            const description = fieldInfo?.description || '';
                            const value = fields[key];
                            
                            formHtml += `<div class="col-md-4">
                                <div class="field-wrapper">
                                    <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                        <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                        <span>${key}</span>
                                    </label>
                                    <input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                            
                            if (description) {
                                formHtml += `
                                    <div class="config-hint mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <small>${description}</small>
                                    </div>
                                `;
                            }
                            formHtml += '</div></div>';
                        }
                    });
                    formHtml += '</div></div>';
                    
                    // V2 RIGHT ARM Variables
                    formHtml += `
                        <div class="servo-group mb-3">
                            <h6 class="servo-group-title"><i class="bi bi-arrow-right-circle me-2"></i>V2 RIGHT ARM Variables</h6>
                            <div class="row g-3">
                    `;
                    v2RightFields.forEach(key => {
                        if (fields[key] !== undefined) {
                            const fieldId = `config_${section}_${key}`;
                            const fieldInfo = data.field_options[`${section}.${key}`];
                            const description = fieldInfo?.description || '';
                            const value = fields[key];
                            
                            formHtml += `<div class="col-md-4">
                                <div class="field-wrapper">
                                    <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                        <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                        <span>${key}</span>
                                    </label>
                                    <input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                            
                            if (description) {
                                formHtml += `
                                    <div class="config-hint mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <small>${description}</small>
                                    </div>
                                `;
                            }
                            formHtml += '</div></div>';
                        }
                    });
                    formHtml += '</div></div>';
                    
                    // V2 LEFT ARM Variables
                    formHtml += `
                        <div class="servo-group mb-3">
                            <h6 class="servo-group-title"><i class="bi bi-arrow-left-circle me-2"></i>V2 LEFT ARM Variables</h6>
                            <div class="row g-3">
                    `;
                    v2LeftFields.forEach(key => {
                        if (fields[key] !== undefined) {
                            const fieldId = `config_${section}_${key}`;
                            const fieldInfo = data.field_options[`${section}.${key}`];
                            const description = fieldInfo?.description || '';
                            const value = fields[key];
                            
                            formHtml += `<div class="col-md-4">
                                <div class="field-wrapper">
                                    <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                        <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                        <span>${key}</span>
                                    </label>
                                    <input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                            
                            if (description) {
                                formHtml += `
                                    <div class="config-hint mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <small>${description}</small>
                                    </div>
                                `;
                            }
                            formHtml += '</div></div>';
                        }
                    });
                    formHtml += '</div></div>';
                    
                    // Torso Height Variables
                    formHtml += `
                        <div class="servo-group mb-3">
                            <h6 class="servo-group-title"><i class="bi bi-arrow-up-down me-2"></i>Torso Height Variables</h6>
                            <div class="row g-3">
                    `;
                    torsoFields.forEach(key => {
                        if (fields[key] !== undefined) {
                            const fieldId = `config_${section}_${key}`;
                            const fieldInfo = data.field_options[`${section}.${key}`];
                            const description = fieldInfo?.description || '';
                            const value = fields[key];
                            
                            formHtml += `<div class="col-md-4">
                                <div class="field-wrapper">
                                    <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                        <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                        <span>${key}</span>
                                    </label>
                                    <input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                            
                            if (description) {
                                formHtml += `
                                    <div class="config-hint mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <small>${description}</small>
                                    </div>
                                `;
                            }
                            formHtml += '</div></div>';
                        }
                    });
                    formHtml += '</div></div>';
                    
                    // Left Leg Variables
                    formHtml += `
                        <div class="servo-group mb-3">
                            <h6 class="servo-group-title"><i class="bi bi-arrow-left me-2"></i>Left Leg Variables</h6>
                            <div class="row g-3">
                    `;
                    leftLegFields.forEach(key => {
                        if (fields[key] !== undefined) {
                            const fieldId = `config_${section}_${key}`;
                            const fieldInfo = data.field_options[`${section}.${key}`];
                            const description = fieldInfo?.description || '';
                            const value = fields[key];
                            
                            formHtml += `<div class="col-md-4 col-lg-3">
                                <div class="field-wrapper">
                                    <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                        <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                        <span>${key}</span>
                                    </label>
                                    <input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                            
                            if (description) {
                                formHtml += `
                                    <div class="config-hint mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <small>${description}</small>
                                    </div>
                                `;
                            }
                            formHtml += '</div></div>';
                        }
                    });
                    formHtml += '</div></div>';
                    
                    // Right Leg Variables
                    formHtml += `
                        <div class="servo-group mb-3">
                            <h6 class="servo-group-title"><i class="bi bi-arrow-right me-2"></i>Right Leg Variables</h6>
                            <div class="row g-3">
                    `;
                    rightLegFields.forEach(key => {
                        if (fields[key] !== undefined) {
                            const fieldId = `config_${section}_${key}`;
                            const fieldInfo = data.field_options[`${section}.${key}`];
                            const description = fieldInfo?.description || '';
                            const value = fields[key];
                            
                            formHtml += `<div class="col-md-4 col-lg-3">
                                <div class="field-wrapper">
                                    <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                        <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                        <span>${key}</span>
                                    </label>
                                    <input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                            
                            if (description) {
                                formHtml += `
                                    <div class="config-hint mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <small>${description}</small>
                                    </div>
                                `;
                            }
                            formHtml += '</div></div>';
                        }
                    });
                    formHtml += '</div></div>';
                } else {
                    // Regular sections - use standard layout
                    formHtml += '<div class="row g-3">';
                    
                    for (const [key, value] of Object.entries(fields)) {
                        const fieldId = `config_${section}_${key}`;
                        const fieldInfo = data.field_options[`${section}.${key}`];
                        const description = fieldInfo?.description || '';
                    
                    formHtml += `<div class="col-md-6 col-lg-4">
                        <div class="field-wrapper">
                            <label for="${fieldId}" class="form-label small d-flex align-items-center">
                                <i class="bi bi-gear-fill me-1" style="font-size: 10px; opacity: 0.5;"></i>
                                <span>${key}</span>
                            </label>`;
                    
                    if (fieldInfo && fieldInfo.options) {
                        // Dropdown for fields with predefined options
                        formHtml += `<select class="form-select form-select-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}">`;
                        fieldInfo.options.forEach(option => {
                            const selected = String(value) === String(option) ? 'selected' : '';
                            formHtml += `<option value="${option}" ${selected}>${option}</option>`;
                        });
                        formHtml += '</select>';
                    } else if (typeof value === 'boolean' || value === 'True' || value === 'False') {
                        // Checkbox for boolean values
                        const checked = (value === true || value === 'True') ? 'checked' : '';
                        formHtml += `
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input config-toggle" type="checkbox" id="${fieldId}" data-section="${section}" data-key="${key}" ${checked}>
                                <label class="form-check-label small text-white" for="${fieldId}" id="${fieldId}_label">
                                    ${checked ? 'Enabled' : 'Disabled'}
                                </label>
                            </div>
                        `;
                    } else {
                        // Text input for other values
                        formHtml += `<input type="text" class="form-control form-control-sm config-input" id="${fieldId}" data-section="${section}" data-key="${key}" value="${value}">`;
                    }
                    
                    if (description) {
                        formHtml += `
                            <div class="config-hint mt-1">
                                <i class="bi bi-info-circle me-1"></i>
                                <small>${description}</small>
                            </div>
                        `;
                    }
                    
                    formHtml += '</div></div>';
                    }
                    
                    formHtml += '</div>';  // Close row
                }
                
                formHtml += '</div></div></div>';  // Close accordion-body, accordion-collapse, accordion-item
                sectionIndex++;
            }
            
            formHtml += '</div>';  // Close accordion
            configForm.innerHTML = formHtml;
            
            // Add event listeners for toggle switches to update label text dynamically
            document.querySelectorAll('.config-toggle').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const label = document.getElementById(this.id + '_label');
                    if (label) {
                        label.textContent = this.checked ? 'Enabled' : 'Disabled';
                    }
                });
            });
        })
        .catch(error => {
            console.error('Error loading configuration:', error);
            document.getElementById('configForm').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>Error loading configuration: ${error.message}
                </div>
            `;
        });
}

function saveConfiguration() {
    const saveBtn = document.getElementById('saveConfigBtn');
    
    // Prevent double-clicking
    if (saveBtn.disabled) {
        return;
    }
    
    const configData = {};
    const inputs = document.querySelectorAll('#configForm input, #configForm select');
    
    inputs.forEach(input => {
        const section = input.getAttribute('data-section');
        const key = input.getAttribute('data-key');
        
        if (!configData[section]) {
            configData[section] = {};
        }
        
        if (input.type === 'checkbox') {
            configData[section][key] = input.checked;
        } else {
            configData[section][key] = input.value;
        }
    });
    
    // Disable button while saving
    const originalHtml = saveBtn.innerHTML;
    const originalClass = saveBtn.className;
    saveBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i><span>Saving...</span>';
    saveBtn.disabled = true;
    
    fetch('/save_config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(configData),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i><span>Saved Successfully!</span>';
            saveBtn.className = 'btn save-config-btn-success';
            
            setTimeout(() => {
                saveBtn.innerHTML = originalHtml;
                saveBtn.className = originalClass;
                saveBtn.disabled = false;
            }, 2000);
        } else {
            // Re-enable button on error
            saveBtn.innerHTML = originalHtml;
            saveBtn.className = originalClass;
            saveBtn.disabled = false;
            alert('Error saving configuration: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        // Re-enable button on error
        saveBtn.innerHTML = originalHtml;
        saveBtn.className = originalClass;
        saveBtn.disabled = false;
        console.error('Error saving configuration:', error);
        alert('Error saving configuration: ' + error.message);
    });
}

// Load configuration when the config tab is clicked
const configTab = document.getElementById('config-tab');
if (configTab) {
    configTab.addEventListener('click', function() {
        const configForm = document.getElementById('configForm');
        if (configForm && configForm.innerHTML.includes('Loading')) {
            loadConfiguration();
        }
    });
}

// Add save button event listener
const saveBtn = document.getElementById('saveConfigBtn');
if (saveBtn) {
    saveBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Save button clicked!');
        saveConfiguration();
    });
}
});
</script>
  
</body>

</html>